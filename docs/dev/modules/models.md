# Модел

Классы сущностей представляют модели предметной области и определяются с использованием формата xml.

Каждый файл должен иметь правильное объявление:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<domain-models xmlns="http://axelor.com/xml/ns/domain-models"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://axelor.com/xml/ns/domain-models https://axelor.com/xml/ns/domain-models/domain-models_6.0.xsd">

    <!-- entity definitions here -->

</domain-models>
```

> Зарезервированные ключевые слова Java нельзя использовать в качестве имен полей. Зарезервированные ключевые слова SQL (PostgreSQL, MySQL и Oracle) нельзя использовать в качестве имен столбцов.

Давайте посмотрим на примере:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<domain-models xmlns="http://axelor.com/xml/ns/domain-models"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://axelor.com/xml/ns/domain-models">

    <module name="contact" package="com.axelor.contact.db"/>

    <entity name="Contact">
        <many-to-one name="title" ref="Title"/>

        <string name="firstName" required="true"/>

        <string name="lastName" required="true"/>

        <string name="fullName" namecolumn="true" search="firstName,lastName">(3)
            <![CDATA[
    if (firstName == null && lastName == null)
        return null;
    if (title == null)
        return firstName + " " + lastName;
    return title.getName() + " " + firstName + " " + lastName;
  ]]></string>

        <date name="dateOfBirth"/>

        <string name="email" required="true" unique="true" max="100"/>
        <string name="phone" max="20" massUpdate="true"/>
        <string name="notes" title="About me" large="true"/>

        <one-to-many name="addresses" ref="Address" mappedBy="contact"/>

        <finder-method name="findByName" using="fullName"/>
        <finder-method name="findByEmail" using="email"/>
    </entity>
</domain-models>
```

1. Ссылается к классу `Title`, тип связи many-to-one
2. Обычное строковое поле
3. Поле с пользовательским кодом, которое совмещает несколько значении.
4. Ссылается к классу `Address`, тип связи one-to-many, плюс указывается поле с "той стороны"
5. Создает специальную функцию для поиска из БД с параметрами

Модель предметной области определяется с помощью <entity>тега, она поддерживает некоторые атрибуты. build.gradle name-
название объекта (должно начинаться с заглавной буквы)

+ `sequential`- использовать ли новую последовательность ID (по умолчанию true)
+ `cacheable`- следует ли сделать этот объект кэшируемым (по умолчанию false)
+ `repository=[none|default|abstract]`- как сгенерировать класс репозитория
+ `table`- имя таблицы для объекта
+ `logUpdates`- включать ли журнал обновлений (по умолчанию true)
+ `extends`- базовый класс сущности наследования
+ `implements`- список интерфейсов для реализации (обычно пустой или подтверждающий геттер/сеттер)
+ `persistable`- сохраняется ли этот объект (в базе данных).
+ `strategy=[SINGLE|JOINED|CLASS]`- стратегия наследования (по умолчанию SINGLE)
+ `equalsIncludeAll`- включать ли все простые нефункциональные поля в тест на равенство (по умолчанию false) - новое в
  версии 5.4
+ `jsonAttrs`- включить/отключить генерацию поля "attrs" json

Атрибут strategy можно использовать только для базовой сущности.

Атрибут persistable можно использовать для определения класса непостоянных сущностей, аннотированных с помощью
@MappedSuperclass которого можно использовать в качестве базового класса других сущностей. Плагин com.axelor.app
определяет точку расширения axelor, где мы определяем различные свойства.

Тег <module>можно использовать для определения имен пакетов сгенерированных сущностей и репозиториев:

```xml
<!-- default behavior -->
<module name="contact"
        package="com.axelor.contact.db"
        repo-package="com.axelor.contact.db.repo"
        table-prefix="contact"/>

        <!-- custom behavior -->
<module name="contact"
        package="my.models"
        repo-package="my.repos"
        table-prefix="my"/>
```

+ `name`- требуется, используется для группировки сущностей в логическом модуле
+ `package`- требуется, используется как имя пакета java сгенерированного класса сущности
+ `repo-package`- является необязательным, используется как имя пакета java сгенерированного класса репозитория, по
  умолчанию<package>.repo
+ `table-prefix`- необязателен, используется как префикс имени таблицы, по умолчанию модульname

> Если имя пакета заканчивается на .db, предпоследняя часть имени пакета используется вместо модуля nameдля префикса таблицы по умолчанию, например, если пакет назван com.axelor.sale.db, saleбудет использоваться в качестве префикса таблицы по умолчанию.

# Поля

Поля разных типов используются для определения свойств модели. Ниже приведены общие атрибуты для всех типов полей:

| Атрибут    | Описание                                                                                                       |
|------------|----------------------------------------------------------------------------------------------------------------|
| name       | название поля (обязательно)                                                                                    |
| title      | отображать название поля                                                                                       |
| help       | подробная строка справки                                                                                       |
| column     | имя столбца базы данных (если имя поля зарезервировано в базовой базе данных)                                  |
| index      | генерировать ли индекс этого поля                                                                              |
| default    | значение поля по умолчанию                                                                                     |
| required   | является ли значение поля обязательным                                                                         |
| readonly   | является ли значение поля доступным только для чтения                                                          | 
| unique     | является ли значение поля уникальным (определяет уникальное ограничение)                                       |
| insertable | включен ли столбец в операторы SQL INSERT, созданные поставщиком сохраняемости — новое в версиях 5.3.8, 5.4.1. |
| updatable  | включен ли столбец в операторы SQL UPDATE, созданные поставщиком сохраняемости — новое в версиях 5.3.8, 5.4.1. |
| hidden     | скрыто ли поле по умолчанию в пользовательских интерфейсах                                                     |
| transient  | является ли поле временным (не может быть сохранено в БД)                                                      |
| initParam  | использовать ли поле в качестве параметра контрагента                                                          |
| massUpdate | разрешить ли массовое обновление этого поля                                                                    |

Нереляционные поля имеют следующие дополнительные атрибуты:

| Атрибут       | Описание                                                                                                                                         |
|---------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| nullable      | разрешить сохранение нулевого значения для полей, которые по умолчанию используют свои системные значения по умолчанию, когда значение не задано |
| selection     | имя ключа выбора                                                                                                                                 |
| equalsInclude | включено ли поле в проверку на равенство - новое в версии 5.4                                                                                    |
| formula       | является ли это собственным полем формулы SQL                                                                                                    |

## Field types

### String

Поле `<string>` используется для определения полей текстовых данных.

Поле принимает следующие дополнительные атрибуты:

| Атрибут      | Описание                                                                                                                 |
|--------------|--------------------------------------------------------------------------------------------------------------------------|
| min          | минимальная длина текстового значения                                                                                    |
| max          | максимальная длина текстового значения                                                                                   |
| large        | использовать ли крупный текст                                                                                            |
| search       | разделенный запятыми список имен полей, используемых компонентом пользовательского интерфейса автозаполнения для поиска. |
| sequence     | использовать указанный генератор пользовательской последовательности                                                     |
| multiline    | является ли строка многострочным текстом (используется компонентами пользовательского интерфейса)                        |
| translatable | является ли значение поля переводимым                                                                                    |
| password     | хранит ли поле текст пароля                                                                                              |
| encrypted    | зашифровано ли поле ( узнать больше )                                                                                    |
| json         | используется ли поле для хранения данных json                                                                            |
| namecolumn   | является ли это столбцом имени (используется компонентами пользовательского интерфейса для отображения записи)           |

### Boolean

Поле `<boolean>` используется для определения полей логического типа.

### Integer

Поле `<integer>` используется для определения недесятичных числовых полей.

| Атрибут      | Описание                                                                                                                 |
|--------------|--------------------------------------------------------------------------------------------------------------------------|
| min          | минимальная длина текстового значения                                                                                    |
| max          | максимальная длина текстового значения                                                                                   |

### Long

Поле `<long>` используется для определения недесятичного числового поля, где значение не может быть представлено integer
типом.

### Decimal

Поле `<decimal>` используется для определения полей десятичного типа с использованием java.math.BigDecimal типа java.

| Атрибут   | Описание                                                              |
|-----------|-----------------------------------------------------------------------|
| min       | минимальное значение (включительно)                                   |
| max       | максимальное значение (включительно)                                  |
| precision | точность десятичного значения (общее количество цифр)                 |
| scale     | шкала десятичного значения (общее количество цифр в десятичной части) |

### Date

Поле `<date>` используется для определения полей для хранения даты с использованием java.time.LocalDate типа java.

### Time

Поле `<time>` используется для определения полей для хранения значений времени с использованием java.time.LocalTime типа
java.

### DateTime

Поле `<datetime>` используется для определения полей для хранения значений даты и времени с использованием
java.time.LocalDateTime типа java.

### Enum

Поле `<enum>` используется для определения полей с типом перечисления Java.

| Атрибут   | Описание                                                              |
|-----------|-----------------------------------------------------------------------|
| ref       | полное имя типа перечисления                                          |

### Binary

Поле `<binary>` используется для хранения двоичных больших двоичных объектов.

| Атрибут   | Описание                                                              |
|-----------|-----------------------------------------------------------------------|
| image     | если поле предназначено для хранения данных изображения               |
| encrypted | зашифровано ли поле                                                   |

> используйте это поле только для небольших или одноразовых двоичных данных, предпочтительнее использовать many-to-one to com.axelor.meta.db.MetaFile.

### «Многие к одному»

Поле `<many-to-one>` используется для определения поля ссылки с одним значением с использованием отношения «многие к
одному».

| Атрибут | Описание                                                                                       |
|---------|------------------------------------------------------------------------------------------------|
| ref     | имя ссылочного класса объектов (FQN, если не в том же пакете)                                  |
| table   | укажите имя таблицы соединения.                                                                |
| column2 | имя столбца внешнего ключа в базовой таблице базы данных, ссылающегося на невладеющую таблицу. |

### «Один к одному»

Поле `<one-to-one>` используется для определения ссылочного поля с одним значением с использованием отношения «один к
одному».

| Атрибут       | Описание                                                                                       |
|---------------|------------------------------------------------------------------------------------------------|
| ref           | имя ссылочного класса объектов (FQN, если не в том же пакете)                                  |
| mappedBy      | для двунаправленных полей имя поля на стороне владельца                                        |
| orphanRemoval | укажите, следует ли удалять потерянные записи, если они были удалены из связи.                 |
| table         | укажите имя таблицы соединения.                                                                |
| column2       | имя столбца внешнего ключа в базовой таблице базы данных, ссылающегося на невладеющую таблицу. |

### «Один ко многим»

Поле `<one-to-many>` используется для определения полей с несколькими значениями с использованием отношения «один ко
многим».

| Атрибут       | Описание                                                                                       |
|---------------|------------------------------------------------------------------------------------------------|
| ref           | имя ссылочного класса объектов (FQN, если не в том же пакете)                                  |
| mappedBy      | для двунаправленных полей имя обратного поля "многие к одному"                                 |
| orphanRemoval | удалять ли потерянные записи (по умолчанию true)                                               |
| orderBy       | указать порядок значения коллекции по заданному полю                                           |
| table         | укажите имя таблицы соединения.                                                                |
| column2       | имя столбца внешнего ключа в базовой таблице базы данных, ссылающегося на невладеющую таблицу. |

### «Многие ко многим»

Поле `<many-to-many>` используется для определения полей с несколькими значениями с использованием отношения «многие ко
многим».

| Атрибут  | Описание                                                                                       |
|----------|------------------------------------------------------------------------------------------------|
| ref      | имя ссылочного класса объектов (FQN, если не в том же пакете)                                  |
| mappedBy | для двунаправленных полей имя поля на стороне владельца                                        |
| orderBy  | указать порядок значений коллекции по заданному полю.                                          |
| table    | укажите имя таблицы соединения.                                                                |
| column2  | имя столбца внешнего ключа в базовой таблице базы данных, ссылающегося на невладеющую таблицу. |

## Другое

### Formula

Поле с аттрибутом `formula="true"` используется для определения фрагмента SQL (также известного как формула) вместо
сопоставления свойства со столбцом. Этот вид свойства доступен только для чтения (его значение вычисляется по вашему
фрагменту формулы). Это поле не будет создано/сохранено в базе данных.

Определенный фрагмент SQL может быть настолько сложным, насколько вы хотите, и он может даже включать подзапросы.

> Вы должны знать, что использование поля формулы требует собственного предложения SQL, которое может повлиять на переносимость базы данных.

```xml

<string name="fullName" namecolumn="true" search="firstName,lastName" formula="true">
    <![CDATA[
        CASE
            WHEN title IS NULL THEN first_name || ' ' || last_name
            ELSE (SELECT contact_title.name FROM contact_title WHERE contact_title.id = title) || ' ' || first_name || ' ' || last_name
        END
  ]]>
</string>

<string name="owner" formula="true">
<![CDATA[
        ( SELECT CASE WHEN c.type = 'owner' THEN c.firstname + ' ' + c.lastname END FROM contacts c where c.folder_id = id )
  ]]>
</string>
```

### Index

Тег `<index>` может использоваться для определения составного индекса.

Он определяется путем указания в `columns` атрибуте списка имен столбцов, разделенных запятыми. Имя может быть
определено с
`name` атрибутом.

```xml

<index columns="firstName,lastName,fullName" name="idx_names"/>
```

Индекс может быть определен для поля с помощью `index` атрибута. Можно указать собственное имя индекса (начиная с
префикса idx_), в противном случае имя индекса по умолчанию генерируется с использованием имени таблицы и имени столбца.
По умолчанию все поля ссылок, `namecolumn`, имя и код автоматически индексируются.

```xml

<string name="firstName" required="true" index="true"/>
<string name="lastName" required="true" index="idx_contact_last_name"/>
```

### Уникальное ограничение

Тег `<unique-constraint>` можно использовать для определения сложного уникального ограничения.

Он определяется путем указания в columns атрибуте списка имен столбцов, разделенных запятыми. Имя может быть определено
с name атрибутом.

```xml

<unique-constraint columns="first_name,last_name"/>
```

### Шифрование поля

Начиная с 5.0, теперь мы можем шифровать конфиденциальные поля. Для использования этой функции необходимы следующие
настройки приложения:

```properties
# Encryption
# ~~~~~
# Set encryption password
encryption.password=MySuperSecretKey
# Set encryption algorithm (CBC or GCM)
#encryption.algorithm = CBC
```

Мы можем пометить `<string>` и `<binary>`поля как зашифрованные следующим образом:

Зашифрованные значения будут длиннее, чем фактические значения, поэтому вы должны убедиться, что размер поля достаточно
хорош для хранения зашифрованного значения в базе данных.

### Слушатели сущностей

Для определения прослушивателей сущностей `<entity-listener>` можно использовать один или несколько тегов. Это добавит
аннотацию к сгенерированному классу сущностей: `@EntityListeners`

```xml

<entity name="Contact">
    ...
    <entity-listener class="com.axelor.contact.db.repo.ContactListener"/>
</entity>
```

Затем вы можете определить свои собственные классы слушателей сущностей с методами обратного вызова, аннотированными
аннотациями событий жизненного цикла, для которых они вызываются:

```java
public class ContactListener {

    // Called upon PostPersist or PostUpdate events on Contact objects.
    @PostPersist
    @PostUpdate
    private void onPostPersistOrUpdate(Contact contact) {
        System.out.println("Contact saved");
    }
}
```

Аннотации событий жизненного цикла:

+ @PrePersist
+ @PostPersist
+ @PreRemove
+ @PostRemove
+ @PreUpdate
+ @PostUpdate
+ @PostLoad

[Прев.](../dev-menu.md)