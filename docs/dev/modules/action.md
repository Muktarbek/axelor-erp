# Действия

В предыдущей главе мы проверили представления объектов. Однако представления требуют действий, чтобы сделать что-то
полезное, кроме операций CRUD.

Действия также определяются с помощью xml и могут использоваться для изменения представлений, объектов, вызовов
контроллеров или выполнения некоторых конкретных задач, таких как отправка электронной почты, импорт удаленных данных и
т. д.

В этой главе мы увидим различные виды действий.

## Концепции

Действия можно использовать для выполнения некоторых расширенных операций с представлением, в том числе:

+ предоставление значений по умолчанию
+ изменение значений формы
+ изменение атрибутов поля
+ вызов методов контроллера
+ проверка текущей записи

Действия можно использовать повторно. Поэтому каждому действию должно быть присвоено уникальное имя.

## События

Действия могут выполняться на различных событиях. Это включает в себя:

+ `onNew`- при создании новой записи
+ `onLoad`- когда запись загружается в виде формы
+ `onSave`- когда запись собирается сохранить
+ `onChange`- при изменении значения поля
+ `onSelect`- при нажатии кнопки выбора записи (только реляционные поля)
+ `onClick`- при нажатии поля/кнопки

## Контекст

Контекст представляет собой карту пары ключ-значение текущего редактируемого объекта. Контекст может содержать некоторую
дополнительную информацию, например __parent__контекст. Кроме того, значения многозначных полей (O2M/M2M) помечаются
флажком, selectedчтобы проверить, выбрана ли запись.

Доступны следующие дополнительные атрибуты: ( новое в версии 5.4 )

+ `_viewName`- название текущего вида
+ `_viewType`- тип текущего вида
+ `_views`- все представления, определенные текущим представлением действия
+ `_source`- имя источника действия (имя поля)

## Выражения

В действиях xml используются динамические выражения для доступа к значениям объектов или условные тестовые выражения для
включения/отключения действий.

Выражение является либо:

+ заводное выражение - с префиксом eval:
+ выражение выбора — запросы выбора JPQL с префиксом select:
+ выражение действия - другое действие с префиксом action:
+ call expression - вызвать метод с префиксом call:
+ константное выражение - выражение считается постоянным значением

Эти выражения могут быть определены в синтаксисе groovy или Java EL . Поддержка Java EL была добавлена ​​в v4.0.

Мы можем смешивать синтаксис обоих выражений в одном и том же определении действия. Правила таковы:

1. выражения `eval`:считаются заводными выражениями
2. выражения `select`:считаются выражением Java EL
3. выражение, завернутое внутрь `#{…}`, считается выражением Java EL

Подробно о правилах:

+ `expr="eval: …"`- использовать заводной
+ `expr="select: …"`- использовать ЭЛ
+ `expr="#{…}"`- использовать ЭЛ
+ `expr="…"`- вернуть как есть (постоянно)
+ `search="…"`- выражение поиска action-record обрабатывается с помощью EL
+ `if="#{…}"`- использовать ЭЛ
+ `if="eval: …"`- использовать заводной
+ `if="select: …"`- использовать ЭЛ
+ `if="…"`- использовать заводной

Выражения EL могут использовать следующие предопределенные вспомогательные функции:

+ `is(Object, Class)`- проверить, является ли данный объект экземпляром класса
+ `as(Object, Class)`- приведение объекта к заданному классу (как правило, приведение происходит автоматически в EL, но
  полезно для преобразования контекста в класс модели)
+ `str(Object)`- преобразовать объект в строку (если null, возвращает пустую строку "")
+ `imp(String)`- импортировать класс по имени
+ `repo(Class)`- получить репозиторий данного класса модели
+ `fmt:text(String, Object…)`- помощник формата строки

Некоторые примеры:

```xml

<action-attrs name="action-test">
    <attribute
    ... if="code == 'some'" expr="eval: __self__?.customer?.fullName" />
    <attribute
    ... if="#{code == 'some'}" expr="#{ __self__.customer.fullName }" />
    <attribute
    ... expr="call: com.axelor.contact.SomeController:method" />
    <attribute
    ... expr="select: s.fullName from Contact s where s.code = :code" />
</action-attrs>
```

### Встроенные переменные

Некоторые встроенные переменные доступны для использования с выражениями. Это включает в себя:

+ `__date__`- текущая дата какLocalDate
+ `__time__`- текущая дата и время какLocalDateTime
+ `__datetime__`- текущая дата и время какZonedDateTime
+ `__user__`- текущий пользователь
+ `__this__`- редактируемая запись (представляющая значения формы)
+ `__self__`- соответствующая запись из базы данных
+ `__parent__`- родительская запись
+ `__ref__`- выбранная запись в режиме многообъектного поиска
+ `__id__`- ID текущей записи
+ `__ids__`- список ID выбранных записей
+ `__config__`- конфигурация глобального контекста

### Специальные действия

Следующие специальные действия могут использоваться для выполнения некоторых специальных операций:

+ `sync`- для синхронизации записи можно использовать только в начале или в конце
+ `save`- для сохранения записи можно использовать где угодно
+ `new`- начать новую запись, можно использовать только в конце
+ `close`- закрыть текущий вид, можно использовать только в конце
+ `validate`- проверить текущую форму, можно использовать где угодно

Например:

```xml

<form ...>
        ...
        <!-- save current form before executing some-action,
             and save again at the end -->
<field name="some" onChange="save,some-action,another-action,save"/>
        ...
        <!-- close current view after action is complete -->
<field name="some" onChange="some-action,close"/>
        </form>
```

[Прев.](../dev-menu.md)